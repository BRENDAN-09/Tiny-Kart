var cp = [
[-118.41984,70.0,0.221312,70.0],
[-110.33936,-24.234455999999998,-38.52516000000001,-23.382904],
[-114.88104,-81.85616,-38.809008000000006,-96.33256],
[-215.648,-229.17464,-41.93136,-109.67352000000001],
[-68.613328,-340.160312,-1.908416,-163.32128],
[184.01384,-320.006872,1.781648,-164.45672000000002],
[244.33679999999998,-241.296408,2.964992,-162.30928],
[151.71735999999999,-56.458544,0.559296,-160.705512],
[15.588152000000001,-7.239848,-39.054120000000005,-106.17904],
[-51.684472,0.42412,-44.5882,-100.05904],
[-112.14464,-2.6982399999999997,-107.03536,-78.202528],
[-177.43031200000001,-6.388296,-171.75336,-85.01496],
[-192.19056,-5.820600000000001,-256.90856,-79.905632],
[-194.46135999999998,2.978776,-289.26752799999997,-0.42743200000000003],
[-193.326,8.088087999999999,-271.384968,58.329664],
[-182.823512,13.765104,-186.79744,91.82408000000001],
[-105.89992,17.45516,-105.0484,90.68864],
[-46.575160000000004,17.739008000000002,-39.762744,95.23024000000001],
[-31.08844,0.436216,52.931376,87.5784],
[3.541352,-42.425232,56.621432,-30.219656],
[24.262456,-89.26064,54.350624,-47.250696000000005],
[73.65247199999999,-102.6016,58.608384,-47.534552000000005],
[111.1208,-88.12519999999999,62.86615200000001,-45.831447999999995],
[121.62328000000001,-50.373056,64.28540000000001,-35.045120000000004],
[136.66736,2.139328,44.983552,23.428128],
[176.97416,16.048008,70.81396799999999,95.81008],
[192.01823199999998,21.15732,140.993688,101.41848],
[230.33808,133.84608,141.20895199999998,102.62248],
[179.5288,212.47272,84.4388,100.91936],
[25.634928000000002,303.99031199999996,43.929663999999995,182.200872],
[-23.74612,300.81184,-14.073744000000001,163.59328],
[-148.12528,268.806,-26.415256000000003,157.40495199999998],
[-144.51672,130.07736,-27.468056,156.034488],
[-114.44552,112.43560000000001,9.848928,112.43560000000001]]

var rp=[
{x:-75.09497168819394,y:22.24473321373775,z:70.00843702007452,theta:4.560877967661861},
{x:-81.38020696773776,y:22.24474578996262,z:-23.59331553355671,theta:4.7202052283723654},
{x:-84.6269691815433,y:19.892701364169113,z:-87.43163507780675,theta:4.654362288537584},
{x:-75.0491966683085,y:17.819214563375986,z:-131.55203750579238,theta:5.156330253068708},
{x:-11.331720138138653,y:16.348577920778183,z:-187.91939595939792,theta:5.651329929372226},
{x:54.455244408826026,y:23.112379503790326,z:-209.71820514133245,theta:6.4628349386682205},
{x:76.97458681241525,y:23.659004675826743,z:-186.68103233265273,theta:7.721396037114548},
{x:58.580765296137464,y:28.866476515155824,z:-121.31674478411502,theta:8.555694329789457},
{x:-6.50283801524822,y:40.98952011736962,z:-48.262148352049394,theta:8.744007160289009},
{x:-49.0438250834816,y:45.896893491310706,z:-32.76558569222707,theta:9.364585415222916},
{x:-109.21769939559049,y:51.24750909825262,z:-35.1290083913133,theta:9.506880438996966},
{x:-174.3106703839125,y:57.068568564203055,z:-40.507679978353565,theta:9.506880566429212},
{x:-216.28639561004886,y:57.435368287569624,z:-33.73958712799691,theta:9.000575591077334},
{x:-237.4722899343408,y:57.52195056075686,z:1.4065311394548488,theta:7.9929078779790945},
{x:-230.60429114005223,y:57.83601652290142,z:31.76514174615526,theta:7.232799544136575},
{x:-184.98192579649063,y:57.876543031620244,z:51.72064619059272,theta:6.240630764017327},
{x:-105.61132833796246,y:55.20156403812556,z:50.877577901128944,theta:6.230080453064724},
{x:-43.904261899601956,y:56.21566649152616,z:49.498069807613874,theta:6.248802133485421},
{x:2.016322484379244,y:61.84544367414697,z:35.04125784971721,theta:5.232715490533838},
{x:30.355360952665233,y:68.2678546963332,z:-35.652547608471224,theta:5.031573078059255},
{x:43.4280625687946,y:68.03686038033534,z:-62.31693484996394,theta:5.571266330368717},
{x:64.98082576428497,y:66.80989312051454,z:-71.36810268851322,theta:6.165653751975275},
{x:80.87508868119015,y:65.67524698631107,z:-61.660783681265826,theta:7.241560786278207},
{x:92.63950643286584,y:64.58053702175255,z:-42.71633937757424,theta:7.386306855699374},
{x:96.190669416279,y:59.48840012088812,z:11.04970341666766,theta:7.797854216290164},
{x:106.39475347252503,y:52.59658606726062,z:68.94238166594523,theta:7.431183176373773},
{x:151.18959472183738,y:44.63685136985163,z:85.17355759873193,theta:6.237901205864567},
{x:181.22083565543775,y:38.45793569003914,z:116.26237414501732,theta:7.9749730185291945},
{x:138.33513300397024,y:24.1739179153601,z:163.39995486273355,theta:8.663510120718007},
{x:37.3321816548715,y:20.55670315257469,z:230.07439660948967,theta:9.457045244874406},
{x:-17.03979325244941,y:10.522131550016473,z:212.2334823239554,theta:9.617355729362945},
{x:-94.53036553694517,y:9.778657672244531,z:220.69903068485775,theta:10.142258032263634},
{x:-83.47389286050029,y:22.90407429209025,z:143.8400436480441,theta:11.36294352255499},
{x:-74.92291964882533,y:22.24472744514159,z:112.94268130059118,theta:11.167279716782232}]

var startPos = new THREE.Vector3(-73.947768,21.24472,77.52212)
var startTheta = 3.141592653589793
var trackFile='./tracks/lunar/course.glb'
var collisionFile='./tracks/lunar/kcl.glb'
var vrFile='./tracks/lunar/vrcorn.glb'
var numLaps = 3
var boosts = []
var materials = [];
var floor = []
var walls = []
var collision = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000000000)
loader = new THREE.GLTFLoader();
scene = new THREE.Scene()

s1 = texLoad.load("./tracks/Lunar/Shadow1.png");
s2 = texLoad.load("./tracks/Lunar/Shadow2.png");

loader.load(trackFile, function(gltf, err) {
  console.log(err);
  root = gltf.scene;
  gltf.scene.traverse(function(node) {
    if((node instanceof THREE.Mesh && node.geometry.attributes.uv2)){
      console.log(`${node.name} has 2 uvs`);
      node.material = shadowMat(node.material.map,node.name.split("_")[0]=="S2"?s2:s1);
    }else if (node instanceof THREE.Mesh){
      node.material = flatMat(node.material.map);
      node.material.side = THREE.DoubleSide;
      node.material.transparent = true;
    }
  })
  scene.add(root)
  count(3)
  finalize()
  animate()
});

loadKcl(collisionFile)
loadVrcorn(vrFile)


function finalize(){
  //composer.addPass(THREE.AfterImagePass)
  scene.getObjectByName("water").material = waterMat;
  scene.getObjectByName("boost").material = boostMat;
  scene.getObjectByName("rainbowRings_Dub").material = boostMat;
}

function update(){
  waterMat.uniforms.time.value+=0.02;
  boostMat.uniforms.time.value+=0.02;
}

var shadowFile = 'tracks/old_town_ds/Mtw_shadow.png'
var cp = [
[-283.2,101.2,-204.40964000000002,101.218064,0,false],
[-283.44703200000004,-2.507848,-204.64703200000002,-2.507848,0,false],
[-283.44703200000004,-42.907848,-204.64703200000002,-42.907848,1,true],
[-283.44703200000004,-79.707848,-205.047032,-79.707848,1,true],
[-283.44703200000004,-112.107848,-204.24703200000002,-112.107848,0,false],
[-286.247032,-149.30784,-209.047032,-149.30784,1,true],
[-301.647032,-172.25784,-239.368672,-203.407856,1,true],
[-317.44703200000004,-207.30784,-246.66959200000002,-207.393408,1,true],
[-305.847032,-240.50784,-245.997016,-211.80784,1,true],
[-274.647032,-266.10784,-243.336264,-214.80784,1,true],
[-240.14703200000002,-282.20784000000003,-239.797016,-215.30784,1,true],
[-212.64703200000002,-278.10784,-236.347016,-213.155,1,true],
[-183.847032,-270.10784,-234.747,-208.305,1,true],
[-165.047032,-252.10784,-236.96508,-203.63516800000002,1,true],
[-163.047032,-231.10500000000002,-219.89703200000002,-178.157856,1,true],
[-159.847032,-231.10500000000002,-159.847032,-190.50784,1,true],
[-125.44703200000001,-231.10500000000002,-125.44703200000001,-190.50784,1,true],
[-103.04703200000002,-237.505,-65.84703200000001,-190.10784,1,true],
[-104.247032,-249.70784,-66.64703200000001,-249.70784,0,false],
[-104.64703200000001,-264.90784,-67.262816,-264.90784,1,true],
[-104.64703200000001,-297.30784000000006,-65.047032,-268.10784,1,true],
[-60.647032,-298.50784000000004,-60.647032,-273.17356,1,true],
[-27.847032,-298.50784000000004,-27.847032,-273.173592,1,true],
[5.73944,-294.862752,-1.047032,-269.70784000000003,1,true],
[46.552968,-272.50784000000004,24.552968,-254.90784,1,true],
[70.152968,-212.10784,38.952968,-212.10784,1,true],
[71.494296,-177.249064,38.952968,-177.24908,1,true],
[62.4,-135.2,39.2,-135.2,1,true],
[62.4,-113.60000000000001,39.2,-113.60000000000001,1,true],
[62.4,-91.2,39.2,-91.2,1,true],
[62.4,-69.60000000000001,39.2,-69.60000000000001,1,true],
[60.4,-64.0,40.0,-33.2,1,true],
[68.8,-53.6,40.761416,-22.876792000000002,1,true],
[73.60000000000001,-49.6,73.60000000000001,-23.21528,1,true],
[98.4,-49.6,98.4,-23.2,1,true],
[123.2,-49.6,123.2,-22.97588,1,true],
[76.0,-173.6,76.0,-152.0,1,true],
[96.0,-173.6,96.0,-152.0,1,true],
[113.60000000000001,-173.6,113.60000000000001,-152.0,1,true],
[138.312528,-169.869688,118.48928000000001,-149.42318400000002,1,true],
[156.0,-152.4,134.8,-131.6,1,true],
[168.025856,-127.925792,140.81292000000002,-127.925792,1,true],
[168.49360800000002,-108.46775199999999,141.514512,-108.46775199999999,1,true],
[168.503016,-86.47156,141.51452799999998,-85.833872,1,true],
[167.91388800000001,-65.6,141.51452799999998,-65.6,1,true],
[167.993,-2.161864,132.4,-2.0,1,false],
[167.847184,13.745816000000001,127.953208,13.540175999999999,1,true],
[229.55404800000002,35.214888,120.8,35.2,1,true],
[229.6,81.60000000000001,120.8,81.60000000000001,1,true],
[148.8,96.8,120.8,96.8,1,true],
[148.8,126.4,120.8,126.4,1,true],
[148.8,135.2,120.8,168.0,1,true],
[198.4,108.0,198.4,168.0,2,true],
[242.4,108.0,242.4,168.0,2,false],
[284.0,106.0,284.0,172.8,2,true],
[358.699936,105.80400800000001,305.6,172.8,2,true],
[348.0,184.25009599999998,305.6,184.25009599999998,3,true],
[337.323872,213.084656,300.982752,198.784144,3,true],
[328.666,231.742512,294.91571999999996,212.376,3,true],
[304.00606400000004,255.892752,280.456816,225.192232,3,true],
[236.8,288.8,236.8,243.20000000000002,3,true],
[203.20000000000002,288.0,203.20000000000002,232.0,4,true],
[174.8,289.6,174.4,168.4,4,false],
[92.0,344.0,92.0,168.0,4,true],
[52.0,344.0,52.0,104.0,5,false],
[-63.066504,326.62309600000003,-64.0,104.0,5,true],
[-106.75447199999999,313.81600000000003,-105.89484,137.981784,5,true],
[-156.99872,286.44928000000004,-156.700096,146.27728,5,true],
[-274.374248,260.855376,-203.89484,173.50790400000002,5,true],
[-279.09484000000003,165.907904,-213.157656,165.921112,5,true],
[-282.940064,127.02152000000001,-209.893784,126.925832,0,true],
[274.40000000000003,171.20000000000002,249.650752,171.057872,4,true],
[271.362312,199.555816,249.250752,183.882408,4,true],
[248.186512,221.178688,228.45075200000002,205.482408,4,true],
[245.74778400000002,226.580264,221.817544,215.080704,4,true],
[241.191832,243.829952,220.854128,232.77976800000002,4,true]]
var rp = [
[-242.4,35.712,110.4,180.00],
[136.8,35.712,76.0,0.00],
[221.6,32.256,148.0,90.00],
[320.082216,32.256,197.813456,-20.00],
[173.6,28.8,258.4,-90.00],
[-10.536392,28.8,243.48151199999998,-90.00]]
var startPos = new THREE.Vector3(-241.92000000000002,35.712,102.8)
var startTheta = 3.141592653589793
var trackFile='./tracks/old_town_ds/course.glb'
var collisionFile='./tracks/old_town_ds/kcl.glb'
var vrFile='./tracks/old_town_ds/vrcorn.glb'
var trackName='old_town_ds'
var numLaps = 3
var floor = []
var walls = []
var collision = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000000000)
loader = new THREE.GLTFLoader();
scene = new THREE.Scene()

var texLoad = new THREE.TextureLoader(), shadowMap
if(shadowFile!=undefined)shadowMap = texLoad.load(shadowFile)
//load model
loader.load(trackFile, function(gltf, err) {
  console.log(err);
  root = gltf.scene;
  gltf.scene.traverse(function(node) {
    if(shadowMap!=undefined&& node instanceof THREE.Mesh && node.geometry.attributes.uv2){
      console.log(`${node.name} has 2 uvs`);
      node.material = shadowMat(node.material.map,shadowMap);
    }else if (node instanceof THREE.Mesh){
      node.material = flatMat(node.material.map);
    }
  })
  scene.add(root)
  count(3)
  finalize()
  animate()
});

//load collision and bg
loadKcl(collisionFile)
loadVrcorn(vrFile)


function finalize(){

}
//called every frame
function update(){

}

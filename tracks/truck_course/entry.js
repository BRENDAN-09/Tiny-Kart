var shadowFile = 'tracks/truck_course/TR_SF_shadow.png'
var cp = [
[-165.775032,205.76,-117.477648,205.76,0,false],
[-165.67818400000002,186.86284,-111.55589599999999,187.11309599999998,0,true],
[-165.661408,154.392544,-110.44816,154.466672,1,false],
[-165.73137599999998,118.4002,-109.366584,143.773624,1,true],
[-122.48212,112.775952,-105.635976,131.668936,1,true],
[-95.908648,89.688928,-81.592968,105.980168,1,true],
[-69.462512,59.828432,-48.112984,67.0668,1,true],
[-67.399768,18.57448,-45.532184,18.390592,2,true],
[-67.452848,-20.419536,-46.679648,-20.421344,2,true],
[-67.568992,-79.42752800000001,-46.508456,-79.33252,3,true],
[-67.57919199999999,-110.01108,-40.891928,-109.94114400000001,3,true],
[-71.377504,-139.293,-45.97292,-156.46856,3,true],
[-91.608864,-151.867544,-82.019472,-175.675544,3,true],
[-116.547296,-161.942984,-108.02615200000001,-178.586408,13,true],
[-154.2798,-165.365472,-118.031136,-185.94892000000002,13,true],
[-162.54173600000001,-203.37509599999998,-120.290904,-203.5678,13,true],
[-157.40865599999998,-259.820936,-116.91402400000001,-221.076872,4,true],
[-95.790296,-248.503264,-95.772696,-224.63756,4,true],
[-48.599984,-248.60475200000002,-48.723743999999996,-224.768472,4,true],
[-17.527528,-243.06844,-17.506152,-224.618032,5,false],
[18.916520000000002,-257.391144,16.535624,-209.75421599999999,5,true],
[63.603712,-240.29392,42.322408,-200.696472,5,true],
[93.400344,-225.331296,86.117168,-187.572856,5,true],
[118.521208,-225.33972,118.611776,-187.573512,6,true],
[155.345576,-218.73236,160.319488,-201.58072,6,true],
[213.304392,-252.273392,201.076216,-206.25416,6,true],
[245.23790400000001,-246.199592,213.413112,-200.692672,6,true],
[264.094904,-218.164016,224.03859200000002,-191.48649600000002,7,true],
[286.073784,-154.28036,229.80884,-154.445784,7,true],
[276.378904,-97.974648,229.695872,-97.986008,7,true],
[263.059472,-40.316048,224.291344,-40.381448,8,true],
[263.005,17.481047999999998,224.384704,27.155192,8,true],
[281.631784,61.17984,240.71188800000002,68.419768,9,false],
[281.768816,122.767472,240.76757600000002,102.36703999999999,9,true],
[228.620752,162.560752,194.246424,131.071032,9,true],
[218.642216,195.14600000000002,178.972984,189.80876800000001,10,true],
[206.223184,272.553344,173.074392,214.30185600000002,10,true],
[141.175576,313.933784,140.418936,218.76500000000001,11,true],
[112.351224,306.895032,112.830168,218.693456,11,true],
[36.633216000000004,278.293064,36.814592,218.547704,12,false],
[5.803368000000001,278.366968,5.937328000000001,218.583688,12,true],
[-38.299208,274.81559200000004,-35.59816000000001,228.732112,12,true],
[-62.68808800000001,270.548344,-62.511,250.892752,12,true],
[-126.15307200000001,289.761032,-109.741552,251.058952,14,true],
[-163.106952,253.38320000000002,-114.253032,245.083264,14,true]]
var rp = [
[-133.56,73.926,214.96,180.00],
[-130.948104,74.0,131.18121599999998,124.00],
[-59.245712,73.999992,51.19992,180.00],
[-66.644912,46.214,-153.025112,-111.00],
[-129.441216,46.214016,-233.38020000000003,90.00],
[5.77048,46.214,-233.168576,90.00],
[113.98518399999999,45.829888,-205.21111199999999,90.00],
[238.106736,70.066936,-184.242936,0.00],
[239.070832,64.32132800000001,-33.12796,0.00],
[258.59290400000003,69.003296,104.972352,-41.00],
[193.7228,84.534176,200.55736,-16.00],
[135.747264,88.977136,234.1552,-90.00],
[-46.321728,74.00244,259.55431200000004,-90.00],
[-133.727528,46.214,-187.369312,180.00],
[-131.88081599999998,74.00244,254.41060800000002,180.00]]
var startPos = new THREE.Vector3(-133.56,73.926,206.96)
var startTheta = 3.141592653589793
var trackFile='./tracks/truck_course/course.glb'
var collisionFile='./tracks/truck_course/kcl.glb'
var vrFile='./tracks/truck_course/vrcorn.glb'
var trackName='truck_course'
var numLaps = 3
var floor = []
var walls = []
var collision = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000000000)
loader = new THREE.GLTFLoader();
scene = new THREE.Scene()

var texLoad = new THREE.TextureLoader(), shadowMap
if(shadowFile!=undefined)shadowMap = texLoad.load(shadowFile)
//load model
loader.load(trackFile, function(gltf, err) {
  console.log(err);
  root = gltf.scene;
  gltf.scene.traverse(function(node) {
    if(shadowMap!=undefined&& node instanceof THREE.Mesh && node.geometry.attributes.uv2){
      console.log(`${node.name} has 2 uvs`);
      node.material = shadowMat(node.material.map,shadowMap);
    }else if (node instanceof THREE.Mesh){
      node.material = flatMat(node.material.map);
    }
  })
  scene.add(root)
  count(3)
  finalize()
  animate()
});

//load collision and bg
loadKcl(collisionFile)
loadVrcorn(vrFile)


function finalize(){

}
//called every frame
function update(){

}

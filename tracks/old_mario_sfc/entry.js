var shadowFile = 'tracks/old_mario_sfc/shadow.png'
var cp = [
[-146.426816,-25.854696,-83.462192,-26.086496,0,false],
[-147.122232,-41.975904,-83.651008,-41.339656000000005,0,true],
[-147.122232,-55.690968000000005,-83.693608,-54.960312,0,true],
[-146.881608,-69.646648,-83.513992,-70.600296,0,true],
[-147.58584,-86.962136,-82.551528,-85.759056,0,true],
[-146.528968,-105.187872,-82.50892,-97.067968,0,true],
[-146.569344,-125.72537600000001,-78.64988000000001,-103.47936800000001,0,true],
[-145.728704,-157.455592,-74.078192,-106.126136,0,true],
[-97.606672,-157.958592,-70.36536,-106.805368,0,true],
[-68.930856,-157.599392,-63.628136,-107.28659200000001,0,false],
[-46.020632,-157.48656,-59.537672,-104.1586,0,true],
[-17.588832,-158.031216,-58.3346,-100.068152,0,true],
[8.796032,-156.995144,-58.316199999999995,-95.06703200000001,0,true],
[7.657352,-117.62048,-57.429744,-85.442448,0,true],
[7.505344,-102.607928,-57.813176,-68.617776,0,true],
[7.86796,-92.57228,-57.036128,-46.225576000000004,0,true],
[11.090368,-91.798648,-11.87748,-46.746,0,true],
[14.845799999999999,-91.79865600000001,9.467064,-46.6424,0,true],
[22.314072,-91.515432,22.941512,-47.31244,0,true],
[32.962144,-91.567208,35.21288,-47.458656000000005,0,true],
[37.73184,-92.015056,61.025496000000004,-47.184632,0,true],
[37.939056,-100.993832,83.478728,-52.849984,0,true],
[37.863040000000005,-109.64674400000001,103.64439999999999,-70.777512,0,true],
[37.348408000000006,-123.30082399999999,99.024296,-95.463064,0,true],
[37.549824,-156.569112,98.759472,-102.20028,0,true],
[84.57239200000001,-157.090512,103.15156,-102.59632,0,true],
[110.756832,-157.443984,109.364952,-102.648128,0,true],
[131.19992000000002,-156.96275200000002,117.54586400000001,-103.129352,0,true],
[149.958688,-157.081312,123.433432,-103.162728,0,true],
[191.94048800000002,-157.791392,127.000056,-103.135152,0,true],
[192.126856,-122.375992,127.49968799999999,-95.822288,0,false],
[192.11185600000002,-100.687224,127.02767200000001,-85.76824800000001,0,true],
[191.69167199999998,-81.2492,126.35764,-76.08264,0,true],
[190.96059200000002,-58.06496,126.777856,-64.82554400000001,0,true],
[191.23716000000002,-6.8281920000000005,126.62016000000001,-58.531,0,true],
[151.458456,0.777576,116.81136000000001,-58.14012,0,true],
[120.022,2.9203040000000002,97.631192,-58.074944,0,true],
[96.429232,4.8747039999999995,74.20732000000001,-46.656224,0,true],
[77.04572800000001,4.8724799999999995,53.584664,-44.338936000000004,0,true],
[56.851152000000006,7.757416,28.066944,-43.938736,0,true],
[39.215824,9.479048,5.815712,-43.678104,0,true],
[21.505976,13.611024,-15.625896000000001,-40.793168,0,true],
[13.902744,15.63048,-40.02684,-39.127264000000004,0,true],
[8.216592,18.040816,-63.977424,-39.578576,0,true],
[7.965296,20.209184,-65.77718399999999,1.969128,0,true],
[7.48136,22.517136,-67.04274400000001,23.15944,0,true],
[10.133664000000001,24.117848000000002,-66.82852000000001,73.608288,0,true],
[17.113376,23.9876,-4.477016,73.701496,0,true],
[26.214936,23.83868,22.520367999999998,73.822528,0,true],
[42.333400000000005,23.83868,43.580432,72.66855199999999,0,true],
[64.268264,15.78884,66.984112,72.576208,0,true],
[84.06264,16.505416,83.89825599999999,72.989536,0,true],
[101.474664,16.505416,102.41536,72.665368,0,true],
[120.39249600000001,16.118064,116.06592,72.526448,0,true],
[144.13090400000002,16.118056,121.71319199999999,73.674976,0,true],
[191.43635999999998,16.146752,124.50816800000001,76.249696,0,true],
[190.096296,62.714696,125.513216,81.27503200000001,0,false],
[191.101344,104.58376,124.90056,84.35692,0,true],
[190.76636,153.583656,122.07692800000001,87.850592,0,true],
[167.64984,153.591512,115.54865600000001,88.472568,0,true],
[134.81778400000002,151.83031200000002,104.828712,85.399984,0,true],
[105.36460799999999,152.69192,90.279344,77.41688800000001,0,true],
[73.537592,152.96956,75.51903200000001,77.321472,0,true],
[45.673448,152.69192,59.438008,77.790648,0,true],
[26.646336,153.38493599999998,35.316488,78.12567200000001,0,true],
[17.600768,154.054984,1.144328,76.50794400000001,0,true],
[8.555200000000001,154.054984,-41.259872,76.201624,0,true],
[-6.56116,152.50036,-44.72488,96.00588800000001,0,true],
[-30.740072,153.55351199999998,-51.626168,100.016832,0,true],
[-53.46412,154.17544,-65.859904,100.90711999999999,0,true],
[-70.5502,154.175456,-75.24049600000001,100.237064,0,true],
[-93.66666400000001,153.84045600000002,-80.265816,99.567024,0,false],
[-146.26500000000001,152.83539199999998,-82.945984,95.881792,0,true],
[-145.929936,119.333288,-83.616032,87.171232,0,true],
[-146.265016,90.52146400000001,-84.62109600000001,75.78052000000001,0,true],
[-145.929968,64.054784,-83.951064,59.36448000000001,0,true],
[-146.264984,39.263216,-83.951056,37.588112,0,true],
[-147.27003200000001,17.151816,-86.29619199999999,14.806672,0,true],
[-147.27003200000001,-4.289536,-86.96624000000001,-3.284472,0,true],
[-146.402392,-22.045664000000002,-85.291136,-22.38068,0,true]]
var rp = [
[-117.2,8.0,-13.200000000000001,180.00]]
var startPos = new THREE.Vector3(-117.76,8.0,-23.637240000000002)
var startTheta = 3.141592653589793
var trackFile='./tracks/old_mario_sfc/course.glb'
var collisionFile='./tracks/old_mario_sfc/kcl.glb'
var vrFile='./tracks/old_mario_sfc/vrcorn.glb'
var trackName='old_mario_sfc'
var numLaps = 3
var floor = []
var walls = []
var collision = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000000000)
loader = new THREE.GLTFLoader();
scene = new THREE.Scene()

var texLoad = new THREE.TextureLoader(), shadowMap
if(shadowFile!=undefined)shadowMap = texLoad.load(shadowFile)
//load model
loader.load(trackFile, function(gltf, err) {
  console.log(err);
  root = gltf.scene;
  gltf.scene.traverse(function(node) {
    if(shadowMap!=undefined&& node instanceof THREE.Mesh && node.geometry.attributes.uv2){
      console.log(`${node.name} has 2 uvs`);
      node.material = shadowMat(node.material.map,shadowMap);
    }else if (node instanceof THREE.Mesh){
      node.material = flatMat(node.material.map);
    }
  })
  scene.add(root)
  count(3)
  finalize()
  animate()
});

//load collision and bg
loadKcl(collisionFile)
loadVrcorn(vrFile)


function finalize(){

}
//called every frame
function update(){

}

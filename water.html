<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Shadow</title>
  <link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>
  <script src="lib/three.min.js"></script>
  <script src="lib/GLTFLoader.js"></script>
  <script src="script/orbit.js"></script>
  <script src="script/waterO.js"></script>
  <script src="script/sky.js"></script>

  <script id="fragmentShader" type="x-shader/x-fragment">
      uniform sampler2D map;
      uniform sampler2D shadowMap;
			varying vec2 vUv;
      varying vec2 vUv2;
			void main( void ) {
        vec4 basCol = texture2D(map,vUv);
        vec4 shadowCol = texture2D(shadowMap,vUv2);
				gl_FragColor = vec4(basCol*shadowCol);
			}
		</script>

    <script id="waterShader" type="x-shader/x-fragment">
        #define shiny 2.0
        uniform sampler2D normalSampler;
        uniform sampler2D bumpSampler;
        uniform float time;
        uniform vec3 basCol;
        uniform vec3 truCol;
  			varying vec3 worldPosition;
        varying vec2 vUv;
        vec3 lightDir = normalize(vec3(0,1,0));
        vec3 sunColor = vec3(1.0,0.9,0.9);

        vec4 getNoise( vec2 uv ) {
  				vec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);
  				vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );
  				vec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );
  				vec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );
  				vec4 noise = texture2D( normalSampler, uv0 ) +
					texture2D( normalSampler, uv1 ) +
					texture2D( normalSampler, uv2 ) +
					texture2D( normalSampler, uv3 );
  				return noise * 0.5 - 1.0;
        }

        vec4 getBump( vec2 uv ) {
  				vec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);
  				vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );
  				vec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );
  				vec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );
  				vec4 noise = texture2D( bumpSampler, uv0 ) +
					texture2D( bumpSampler, uv1 ) +
					texture2D( bumpSampler, uv2 ) +
					texture2D( bumpSampler, uv3 );
  				return noise * 0.5 - 1.0;
        }

  			void main( void ) {
          vec3 worldtoEye = normalize(cameraPosition - worldPosition);
          vec3 normal = getNoise(vUv*3000.0).xyz;
          normal.z*=0.4;
          normal = normalize(normal);
          vec3 reflected = normalize(2.0*dot(lightDir,normal)*(normal-lightDir));
          float bump = getBump(vUv*5120.0).x;
          vec3 color = mix(basCol,truCol,0.5);
          float direction = max(0.0,dot(worldtoEye,reflected));
          vec3 specular = pow(direction, shiny)*sunColor;
  				gl_FragColor = vec4(pow(direction, shiny)>0.9?specular:color,1.0);
  			}
  		</script>


		<script id="vertexShader" type="x-shader/x-vertex">
      attribute vec2 uv2;
      varying vec2 vUv;
      varying vec2 vUv2;
      varying vec3 worldPosition;
			void main()
			{
				vUv = uv;
        vUv2 = uv2;
				vec4 mvPosition = modelMatrix * vec4( position, 1.0 );
        //worldPosition = mvPosition.xyz;
				gl_Position = projectionMatrix * viewMatrix * mvPosition;
			}
		</script>

  <script src="experimental/water.js"></script>
</body>
</html>
